<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <!--

   -->

    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA//8AAPv/AAD4/wAA+38AAPufAAD77wAAA/AAAPvvAAD7nwAA+38AAPj/AAD7/wAA//8AAP//AAD//wAA" rel="icon" type="image/x-icon">

   <title>JPA Model</title>    
   <script src="https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.js"></script>
   <script src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src = "ecal-phase-s11.js"></script>
    <script src = "fghz.js"></script>
    <script src = "biaswave.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>
        MathJax.Hub.Config({
            tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true,
            processClass: "mathjax",
            ignoreClass: "no-mathjax"
            }
        });//			MathJax.Hub.Typeset();//tell Mathjax to update the math
    </script>   
</head>
<body>    
<div id = "scroll">
    <div id = "qrcode"></div>
    <a href = "index.html">HOME</a>
    <h1>JPA MODEL</h1>
    <table id = "controltable"></table>
    <a href = "http://localhost:8888/notebooks/jcal/jpa-model.ipynb">jpa-model.ipynb</a>
    <img src = "graphics/jpa-coax2.svg">
    <p>
        $$
        L = L_0 + \frac{L_J^{min}}{|\cos{(2\pi\phi)}|}
        $$
    </p>
</div>
<style>
body{
    overflow:hidden;
    font-family:arial;
}
table{
    border:solid;
    margin:auto;
    font-size:1.3em;
}
table input{
}
H1{
    text-align:center;
    font-size:3em;
}
#scroll{
    position:absolute;
    left:0px;
    top:0px;
    overflow:scroll;
    bottom:0px;
}
#scroll a{
    text-align:center;
    font-size:2em;
    width:80%;
    margin:auto;
    display:block;
    border:solid;
    border-radius:0.5em;
    border-width:0.5em;
    color:blue;
    margin-top:1em;
    margin-bottom:0.5em;
    overflow-x:scroll;
}
#scroll img{
    max-width:90%;
    display:block;
    margin:auto;
}
main{
    position:absolute;
    right:0px;
    top:0px;
    z-index:-2;
}
</style>
<script>
traceindex = 0;
datatracemode = true;

control ={};
/*
control.coax_length = 0.08;//meters
control.LJmin = 10e-12;//henries
control.L0 = 10e-12;//henries
control.C0 = 9.2e-12;//farads
control.Cin = 1.5e-12;//farads
control.phi = 0.25;//flux bias in fractions of a flux quantumn
*/
loadcontrol();

globalparam = "";

if(innerWidth > innerHeight){
    document.getElementById("scroll").style.right = (innerHeight - 4).toString() + "px";
}

function loadcontrol(){
    var httpc = new XMLHttpRequest();
    httpc.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            control = JSON.parse(this.responseText);
            document.getElementById("controltable").innerHTML = "";
            for(parameter in control){
                var newtr = document.createElement("TR");
                var newtd1 = document.createElement("TD");
                newtd1.innerHTML = parameter;
                newtr.appendChild(newtd1);
                var newtd2 = document.createElement("TD");
                var newinput = document.createElement("INPUT");
                newinput.value = control[parameter];
                newinput.onchange = function(){
                    localparam = this.parentElement.getElementsByTagName("TD")[0].innerHTML;
                    control[localparam] = parseFloat(this.value);
                    savecontrol();

                }
                newinput.onclick = function(){
                    globalparam = this.parentElement.getElementsByTagName("TD")[0].innerHTML;
                }
                newtd2.appendChild(newinput);
                newtr.appendChild(newinput);
                document.getElementById("controltable").appendChild(newtr);
            }
        }
    };
    httpc.open("GET", "load-file.php?filename=control.json", true);
    httpc.send();    
}

function savecontrol(){
    data = JSON.stringify(control,null,"   ");
    var httpc = new XMLHttpRequest();
    var url = "save-file.php";        
    httpc.open("POST", url, true);
    httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");
    httpc.send("data="+data+"&filename=control.json");//send text to save-file.php    
}

/*
codesquaresize = 170;
marginsize = 40;
fontsize = 12;
//globalurl = "http://www.trashrobot.org/qrcode.html";
globalurl = window.location.href;
qrcode = new QRCode(document.getElementById("qrcode"), {
	text: globalurl,
	width: codesquaresize,
	height: codesquaresize,
	colorDark : "#000000",
	colorLight : "#ffffff",
	correctLevel : QRCode.CorrectLevel.H
});
*/

modeldata = {};
loadmodel();


function setup() {
    createCanvas(innerHeight,innerHeight);
}
function draw() {

    loadmodel();

}

function loadmodel(){
    var httpc = new XMLHttpRequest();
    httpc.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            modeldata = JSON.parse(this.responseText);
            plotmodel();
        }
    };
    httpc.open("GET", "load-file.php?filename=model.json", true);
    httpc.send();    
}
function plotmodel(){
    clear();
    background("white");
    noFill();
    stroke(0);
    strokeWeight(4);
    line(0,0.25*height,width,0.25*height);
    line(0,0.5*height,width,0.5*height);
    line(0,0.75*height,width,0.75*height);
    for(ghz = 4;ghz < 9;ghz++){
        line(map(ghz,modeldata.fghz[0],modeldata.fghz[modeldata.fghz.length - 1],0,width),0,map(ghz,modeldata.fghz[0],modeldata.fghz[modeldata.fghz.length - 1],0,width),height);
    }        
    
    strokeWeight(4);
    
    stroke("green");
    beginShape();
    for(var index = 0; index < fghz.length; index++){
        vertex(map(index,0,fghz.length,0,width),map(ecalphasedata[traceindex][index],-180,180,height,0));
    }
    endShape();
    
    stroke("blue");
    beginShape();
    for(var index = 0; index < modeldata.fghz.length; index++){
        vertex(map(index,0,modeldata.fghz.length,0,width),map(modeldata.phase[index],-180,180,height,0));
    }
    endShape();

    stroke(0);
    strokeWeight(1);
    fill(0);
    textSize(30);
    for(ghz = 4;ghz < 9;ghz++){
        text(ghz.toString() + " GHz",map(ghz,fghz[0],fghz[fghz.length - 1],0,width) + 10,30);
    }
    text("0 deg",10,0.5*height - 15);
    text("-90 deg",10,0.75*height - 15);
    text("90 deg",10,0.25*height - 15);
    if(globalparam.length > 0){
        text(globalparam + " = " + control[globalparam],width/2,100);
    }

}

function mouseWheel(event) {

    if(mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height){
        if(!datatracemode){
          if (event.delta > 0) {
            if(globalparam.length > 0){
                control[globalparam]  = 1.01*control[globalparam];
                savecontrol();
            }
          }
          else {
            if(globalparam.length > 0){
                control[globalparam]  = control[globalparam]/1.01;
                savecontrol();
            }
          }
        }
        else{
          if (event.delta > 0) {
            traceindex++;
            if(traceindex > fghz.length - 1){
                traceindex = 0;
            }
          }
          else {
            traceindex--;
            if(traceindex < 0){
                traceindex = fghz.length - 1;
            }
          }
            
        }
      
      //update the current input table value
      rows = document.getElementById("controltable").getElementsByTagName("TR");
      for(var index = 0;index < rows.length;index++){
          var localparam = rows[index].getElementsByTagName("TD")[0].innerHTML;
          if(localparam == globalparam){
              rows[index].getElementsByTagName("input")[0].value = control[globalparam];
          }
      }
      mousewheeltrigger = 1;
      
      // Uncomment to prevent any default behavior.
      // return false;
    }

}


function mouseClicked() {
    
}

function keyPressed() {
  if (key === 'd') {
     datatracemode = !datatracemode;
  }
}
</script>
</body>
</html>


    
    
